# Конфигурация docker container для работы с reverse proxy и внешним сервером базы данных

## Почему Вы можете предпочесть такую конфигурацию

Главное преимущество конфигурации с reverse proxy и внешним сервером базы данных- это экономия ресурсов. Как правило ресурсы NAS довольно ограничены, а дополнительные процессы потребляют память и CPU которому  вероятно есть более полезное применение.

"Обычный" docker-compose.yaml определяет 3 сервиса,  бекенд на php-fpm , база данных Postgres и nginx в качестве front end.  Вместо 2 последних можно использовать существующие сервисы, если они есть. Сервисы не зависят друг от друга, так что можмо "экстернализаровать" оба или только один.

## Работа с внешней Postgres базой данных.
Есть 2 главных отличия в конфигурации внешней и "внутренней" базы данных.
1.  При использовании внутренней базы данных  для траффика между бекендом о БД используется default netwrok автоматически определяемая Docker engine для каждого  docker-compose file. Если БД определена в другом файле, нужно явным образом разрешить коммуникацию межды сервисами. Это делается с помощью explicite network, в [docker-compose.yaml](docker-compose.yaml) из этой директории такой сетью служит postgres_db_net. Сеть с таким же именем дожна быть определана в файле определения сервиса постгресс и эта сеть должна быть прописана в списке сетей для сервиса (конфигурация практически идентична той что есть в примере в этой директории). В таком случае можно создать сеть отдельно, с помощью docker network create (Кроме того во многих GUI/ web interface есть возможность определить такую сеть без command line). Затем можно определить ее как external во всех релевантных docker compose files..
2. Образ созданный в главном docker-compose, определяет юзера БД, таблицы, индексы и т.д. во время создания image. В случае с внешней базой все необходимое должно быть создано при запуске контейнера бекенда Флибусты. Для этого слижит скрипт flibusta_entrypoint.sh . Скрипт проверяет есть ли postgres account определенный как FLIBUSTA_DBUSER в environment docker_compose.yml (default - account flibusta, password - flibusta). Если удается подключиться с таким юзером к БД, скрипт считает что инитиализация уже состоялась при прошлых запусках. Если такая попытка не успешна, скрипт пытается инитиализировать нужные обьекты : создается счет с именем  из переменной окружения FLIBUSTA_DBUSER ( default flibusta) и паролем из /run/secrets/FLIBUSTA_PWD, создается база данных и в ней все нужные таблицы, индексы и т.д. Создание нового счета и базы данных - это привeлигированные опреации, для них используется счет с именем из POSTGRES_ADMIN_USER (default - postgres) и паролем из фаила указанного в POSTGRES_ADMIN_DBPASSWORD_FILE . Проверьте что этот account  имеет необходимые  grants... Административный account используется толкько в скрипте и только если скрипт решает что инициализация необходима. После успешной инициализации можно заменить пароль в POSTGRES_ADMIN_DBPASSWORD_FILE на неправильный если Вы боитесь компрометации этого счета.


## Работа с reverse proxy

Существуют 2 наиболее распространненых типа подключения к  reverse proxy : subdomain и subdir . При подключении как subdomain, ресурс ( в данном случае библиотека)  для адреса https://example.com будет доступна как https://mylib.example.com/ . При подключении как subdir адрес библиотеки https://example.com/mylib. Второй вариант конфигурации ПМСМ сложнее, и поэтому здесь обьясняется именно он.

В качестве reverse proxy в примере в данной директории используется nginx . Если у Вас другой reverse proxy, вместо nginx конфигурации flibusta.conf Вам нужно будет использовать конфигурационные файлы специфичные для Вашего proxy.
В конфигурации в этой директории используется вариант subdir. Для адреса она будет доступна как https://addres of my server/mylib . 

Для конфигурации используются следующие значения
1.  /mylib - путь до "корня" библиотеки. Определяется переменной FLIBUSTA_WEBROOT в environment сервиса flibusta-fpm в  docker_compose.yml
2. flibusta_net - сеть по которой backend  и  reverse proxy связываются, и определяется subnet 172.101.0.0/16
3. 172.101.0.101 адрес бекенда   ( должен быть адресом в сети из предыдущего пункта), задается параметром  ipv4_address сервиса flibusta-fpm
4. 192.168.1.0/24 -локальная сеть . Это значение используется для контроля доступа ( см. обсуждение ниже)  в директиве 
```
allow 192.168.1.0/24;
```
 в конфигурации flibusta.conf для nginx.
5. Файлы из  application/public доступны в докер контейнере nginx как /srv/mylib

Шаги для конфигурации работы с reverse proxy
1. Создайте docker netwrork с именем flibusta_net и subnet 172.101.0.0/16 . Важно чтобы subnet соответствовал адресу flibusta-fpm, который прописан в nginx конфигурационном файле flibusta.conf. Добавьте эту сеть в докер контейнер nginx как external  (похоже на то как она определена в docker-compose.yml из этой директории)
2. Добавьте  volume /srv/mylib : 

```
- <path to flibusta files>/flibusta/application/public:/srv/mylib:v,ro
```
3. Добавьте (предпологается что конфигурация внутри докера находится в /config/nginx, если нет, например часто бывает /etc/etc/config/nginx , соответственно измените  mount) 

```
- <path to flibusta>/flibusta/application/tools/external_services_config/flibusta.conf:/config/nginx/flibusta.conf:v,ro
```
  и сделайте   include конфиг файла flibusta.conf в  server блок в конфигурации nginx, скорее всего конфигурация находится в /config/nginx/site-confs/default.conf  или /etc/config/nginx/site-conf/default.conf 

```
# main server block
server {

    listen 443 ssl default_server;
    listen [::]:443 ssl default_server;
    http2 on;

.......................

   location <something> {

   }

   location <something else> {

   }

   include /config/nginx/flibusta.conf;

   .......

}
 ```

 ## Доступ к Вашему зеркалу Флибусты

 reverse proxy скорее всего дает доступ из интернета к Вашим сервисам ( он скорее всего и нужен чтобы  был доступ к докер контейнерам на Вашем NAS). Я думаю , понятно, что предоставлять неконтролируемый доступ всему интернету к Вашему зеркалу Флибусты не очень хорошая идея. Nginx позволяет давать доступ к определенному ресурсу ( например к директории https://my address/mylib) только определенный  IP адресам или только авторизированным пользователям. flibusta.conf ограничевает дотуп только локальными адресами ( из сети 192.168.1.0/24). Если subnet вашей домашней сети другой - соответственным образом измените файл. Для доступа к библеотеке из интернета для авторизованных пользователей проще всего воспользоваться механизмом Basic authenitcation ( htpassword) примерно так
 ```
location ^~ /mylib {
    #...
    satisfy any;
    allow 192.168.1.0/24;
    deny  all;

    auth_basic "Flibusta forever";
    auth_basic_user_file conf/htpasswd;
    ...
}
 ```

